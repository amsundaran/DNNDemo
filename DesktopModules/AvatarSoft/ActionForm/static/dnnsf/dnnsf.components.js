angular.module("dnnsf.components",["ngSanitize","textAngular"]).directive("fixchange",[function(){return{replace:false,require:"ngModel",scope:false,link:function(d,c,b,a){c.on("change",function(){d.$apply(function(){if(b.type=="radio"){a.$setViewValue(b.value)}else{if(b.type=="checkbox"){a.$setViewValue(c[0].checked)}}})})}}}]).directive("dnnsfRadiogroup",["$compile","$timeout","$parse",function(b,a,c){return{restrict:"A",scope:{model:"=",options:"="},controller:function(d){d.getLabel=function(e){return typeof e.label!="undefined"?e.label:e};d.getValue=function(e){return typeof e.value!="undefined"?e.value:e}},template:'<div class="btn-group" data-toggle="buttons"><label class="btn btn-default btn-sm" data-ng-repeat="o in options" data-ng-class="{\'active\': model == getValue(o), \'btn-info\': model == getValue(o) }"><input type="radio" fixchange="" data-ng-model="$parent.model" value="{{getValue(o)}}" />{{getLabel(o)}}</label></div>',replace:true}}]).directive("dnnsfCheckbox",["$compile","$timeout","$parse",function(b,a,c){return{restrict:"A",scope:{ngModel:"="},link:function(f,e,d){f.changed=function(h){var g=h?e.hasClass("active"):f.ngModel;if(h){f.ngModel=g}if(g){e.addClass("btn-info active")}else{e.removeClass("btn-info")}};f.changed();e.click(function(){a(function(){f.changed(true)})});f.$watch("ngModel",function(){f.changed()})}}}]).directive("dnnsfRegistration",["$timeout","$http","$sce","dnnsf","dataSources",function(c,e,b,a,d){return{scope:true,templateUrl:"static/dnnsf/tpl/licensing.html?v="+a.env.version,link:function(h,g,f){h.dnnsf=a;h.$sce=b;e({method:"GET",url:a.adminApi("GetLicense"),cache:true}).success(function(j,i){h.license=j})}}}]).directive("dnnsfCheckUpdate",["$timeout","$http","$sce","dnnsf","dataSources",function(c,e,b,a,d){return{scope:true,templateUrl:"static/dnnsf/tpl/check-update.html?v="+a.env.version,link:function(h,g,f){h.dnnsf=a;h.$sce=b;e({method:"GET",url:"http://www.dnnsharp.com/DesktopModules/DnnSharp/DnnApiEndpoint/Api.ashx?method=CurrentVersion&productCode="+a.productCode,cache:true}).success(function(j,i){h.serverVersion=j})}}}]).factory("dataSources",["$http","dnnsf",function(b,a){return{callForData:function(d,c){b({method:"GET",url:a.adminApi("GetData",d),cache:true}).success(function(f,e){c&&c(f)})}}}]).directive("ctlDatasource",["$compile","$timeout","$parse","dataSources",function(b,a,c,d){return{scope:{pdef:"=ctlDatasource",model:"=updatemodel",params:"="},template:function(e,f){return e.html()},link:function(g,f,e){if($.type(g.model)!="object"||!g.model.hasOwnProperty("Value")){g.model={Value:g.model,IsExpression:false}}a(function(){if(g.params&&(!g.params.DataSource||!g.params.DataSource.Value)&&g.params.Values){var l=new RegExp("select.+from","gi").test(g.params.Values);g.model={Value:l?"SQL Query":"Items"}}if(g.model&&!g.model.Parameters&&g.params&&g.params.Values){g.model.Parameters={};var l=new RegExp("select.+from","gi").test(g.params.Values);if(l){g.model.Parameters.SqlQuery=g.params.Values||g.params.Items}else{g.model.Parameters.Items=g.params.Values||g.params.Items}}if(g.pdef.Settings.Items){if(!g.model){g.model={}}var j=g.pdef.Settings.Items;if($.type(j)=="string"){j=$.parseJSON(j)}g.items=[];for(var k in j){var h={Value:k,Text:g_localize(j[k])};g.items.push(h);if(g.model&&h.Value==g.model.Value){g.selectedSource=h}}}else{d.callForData(g.pdef.Settings,function(n){g.items=n;if(g.model){for(var m in n){if(n[m].Value==g.model.Value){g.selectedSource=n[m]}}}})}})}}}]).provider("$cookieStore",[function(){var a=this;a.defaultOptions={};a.setDefaultOptions=function(b){a.defaultOptions=b};a.$get=function(){return{get:function(c){var b=$.cookie(c);if(b){return angular.fromJson(b)}},put:function(c,d,b){b=$.extend({},a.defaultOptions,b);$.cookie(c,angular.toJson(d),b)},remove:function(c,b){b=$.extend({},a.defaultOptions,b);$.removeCookie(c,b)}}}}]).directive("dnnsfCheckboxlist",["$compile","$timeout","$parse",function(b,a,c){return{restrict:"A",template:'<div data-ng-repeat="item in internalValues" class="{{cssclass}}"><input type="checkbox" data-ng-model="item.$_selected" data-ng-change="updateSelection(item)" /> {{getTitle({item:item})}}</div>',scope:{cssclass:"@",ngModel:"=",values:"=",getTitle:"&",serializeItem:"&"},link:function(f,e,d){f.$watch("values",function(){f.internalValues=$.extend({},f.values,true)});f.$watch("ngModel",function(){$.each(f.internalValues,function(h,j){var g=f.serializeItem({item:j});j.$_selected=$.inArray(g,f.ngModel)!=-1})});f.getTitle=f.getTitle||function(g){return g};f.serializeItem=f.serializeItem||function(g){return g};f.updateSelection=function(h){var g=f.serializeItem({item:h});if(!h.$_selected&&$.inArray(g,f.ngModel)!=-1){f.ngModel.splice($.inArray(g,f.ngModel),1)}else{if(h.$_selected){f.ngModel.push(g)}}}}}}]).directive("dnnsfCalldirective",["$compile","$timeout","$parse","$sce","dnnsf",function(d,c,e,b,a){return{restrict:"A",scope:true,replace:true,template:"",link:function(m,l,j){var f=$("<div>");for(var k in l[0].attributes){var h=l[0].attributes[k].name;if(h&&h.indexOf("pass-")!=-1){f.attr(h.replace("pass-",""),l[0].attributes[k].value)}}var g=$("<div>").append(f).html();d(g)(m,function(i,n){l.append(i)})}}}]).directive("dnnsfParams",["$compile","$timeout","$parse","$sce","dnnsf",function($compile,$timeout,$parse,$sce,dnnsf){return{restrict:"A",scope:{params:"=dnnsfParams",item:"=dnnsfItem",fields:"=dnnsfFields",fieldFilters:"=dnnsfFieldFilters"},templateUrl:"static/dnnsf/tpl/parameter.html?v="+dnnsf.env.version,link:function(scope,element,attrs){scope.localize=g_localize;scope.$sce=$sce;scope.dnnsf=dnnsf;scope.appendData=function(item,pId){var data="";$.each(scope.fields,function(i,field){if(field.Def&&field.Def.Settings.HasValue=="false"){return}data+=field.Title+": ["+(field.BoundName||field.RefName)+"]<br />"});scope.itemParameters[pId]=(scope.itemParameters[pId]||"")+data};scope.$watch("item",function(){if(scope.item){scope.itemParameters=scope.item.Parameters||scope.item}},true);scope.$watch("item",function(newValue,oldValue){if(scope.item&&angular.equals(newValue,oldValue)){scope.itemParameters=scope.item.Parameters||scope.item}});scope.byType=function(type){var types=dnnsf.eval(type);types=dnnsf.toArray(types);return function(item){return types.length==0||$.inArray(item.InputTypeStr,types)!=-1}};scope.notParentButton=function(action){return function(item){return item!=action.$_field}};scope.notInArray=function(arr,currentItem){return function(input){var i=$.inArray(input.BoundName,arr);if(i!=currentItem&&i!=-1){return false}return true}};scope.exceptItem=function(item){return function(input){return item!=input.BoundName}}}}}]).directive("dnnsfActions",["$compile","$timeout","$parse","$sce","dnnsf",function(d,c,e,b,a){return{restrict:"A",scope:{actions:"=dnnsfActions",fields:"=dnnsfFields",actionDefs:"=dnnsfDefs",actionDefGroups:"=dnnsfDefgroups",eventName:"=eventName"},templateUrl:"static/dnnsf/tpl/action-list.html?v="+a.env.version,link:function(h,g,f){h.localize=g_localize;h.$sce=b;h.$watch("actions",function(){if(!h.actions){return}$.each(h.actions,function(j,k){k.$_uid=a.uniqueId("action")})});h.addAction=function(i){var j={Id:-1,$_uid:a.uniqueId("action"),EventName:h.eventName,Parameters:{},ActionType:i.Id,$_isOpen:true,$_isLoaded:true,$_isFocus:true};a.initParameters(i,j);h.actions.push(j)};h.checkFinal=function(i){if(!h.actionDefs[i.ActionType]){return false}return h.actionDefs[i.ActionType].Final&&!i.Condition&&$.inArray(i,h.actions)!=h.actions.length-1};h.cloneAction=function(i){var j=$.extend({},angular.copy(i),{Id:-1,$_uid:a.uniqueId("action"),$_isOpen:true,$_isLoaded:true,$_isFocus:true});j.Title+=" Copy";a.initParameters(h.actionDefs[i.ActionType],j);h.actions.push(j)}}}}]).directive("dnnsfValidators",["$compile","$timeout","$parse","$sce","dnnsf",function(d,c,e,b,a){return{restrict:"A",scope:{validators:"=dnnsfValidators",vldDefs:"=dnnsfDefs"},templateUrl:"static/dnnsf/tpl/validators.html?v="+a.env.version,link:function(h,g,f){h.localize=g_localize;h.$sce=b;h.addValidator=function(j){var i={Id:-1,$_uid:"vld"+new Date().getTime(),Parameters:{},Type:j.Id,$_isOpen:true,$_isLoaded:true,$_isFocus:true};$.each($.grep(j.Parameters,function(k){return k.DefaultValue}),function(l,k){var m=g_localizeMaybeJson(k.DefaultValue);i.Parameters[k.Id]=m});h.validators.push(i)}}}}]).directive("dnnsfFilepicker",["$compile","$timeout","$parse","$sce","dnnsf","dataSources",function(d,c,e,b,a,f){return{restrict:"A",scope:{ngModel:"="},templateUrl:"static/dnnsf/tpl/filepicker.html?v="+a.env.version,link:function(i,h,g){i.dnnsf=a;i.$sce=b;i.singleSelect=g.dnnsfPickermode=="Single";i.selectedFiles=i.ngModel?angular.copy(i.ngModel):[];i.openFolder=function(k){i.currentFolder=k;i.breadcrumbs=[k];var j=k.$_parent;while(j){i.breadcrumbs.splice(0,0,j);j=j.$_parent}i.loading=true;f.callForData({dataSource:"FilesInFolder",folderId:k.Value},function(o){i.files=o;var p=$.grep(i.selectedFiles,function(r,q){return r.Filter==k.Value});if(p){var n=0;for(var m=0;m<i.files.length;m++){for(var l=0;l<p.length;l++){if(i.files[m].Value==p[l].Value){i.files[m].Selected=true;p[l]=i.files[m];n++;break}}if(n==p.length){break}}}i.loading=false})};i.updateCount=function(k,j){k.selectedCount=(k.selectedCount||0)+j;while(k){k.fullTreeSelectedCount=(k.fullTreeSelectedCount||0)+j;k=k.$_parent}};i.toggleSelectFile=function(m,j){m.Selected=j;if(i.singleSelect){if(i.selectedFiles&&i.selectedFiles.length){i.selectedFiles[0].Selected=false;function l(o){o.selectedCount=o.fullTreeSelectedCount=0;$.each(o.Children,function(p,q){l(q)})}l(i.folder)}i.selectedFiles=[];if(j){i.selectedFiles.push(m)}}else{var n=false;for(var k=0;k<i.selectedFiles.length;k++){if(i.selectedFiles[k].Value==m.Value){if(!j){i.selectedFiles.splice(k,1)}n=true;break}}if(!n&&j){i.selectedFiles.push(m)}}i.updateCount(i.currentFolder,j?1:-1)};i.update=function(){i.ngModel=angular.copy(i.selectedFiles);i.editing=false};i.loading=true;f.callForData({dataSource:"PortalFolders"},function(k){i.folder=k[0];i.folder.$_isExpanded=true;function j(l){var m=$.grep(i.selectedFiles,function(o,n){return o.Filter==l.Value});if(m.length){i.updateCount(l,m.length)}$.each(l.Children,function(n,o){o.$_parent=l;j(o)})}j(i.folder);i.openFolder(i.folder);i.loading=false})}}}]).directive("dnnsfBgPicker",["$compile","$timeout","$parse","$sce","dnnsf","dataSources",function(d,c,e,b,a,f){return{restrict:"A",scope:{model:"=ngModel"},templateUrl:"static/dnnsf/tpl/bg-picker.html?v="+a.env.version,link:function(i,h,g){i.bg={};f.callForData({DataSource:"BgPatterns"},function(j){i.patterns=j});f.callForData({DataSource:"BgImages"},function(j){i.images=j});i.$watch("model",function(){a.log("model changed",i.model);if(i.model==null){return}i.bg.type="None";var l=a.parseCssBlock(i.model);a.log(l);if(l["background-color"]){i.bg.type="Color";i.bg.color=l["background-color"]}else{if(l["background-image"]){var j=l["background-image"];var m=/url\((.+)\)/g;var k=m.exec(j);j=k&&k.length>1?k[1]:j;if(l["background-repeat"]=="no-repeat"){i.bg.type="Image";i.bg.image=j}else{i.bg.type="Pattern";i.bg.pattern=j}}}});i.$watch("bg",function(){a.log("bg changed",i.bg);switch(i.bg.type){case"None":i.model="";break;case"Color":i.model="background-color: "+(i.bg.color||"transparent")+";";break;case"Pattern":i.model="background-image: url("+i.bg.pattern+"); background-repeat: repeat;";break;case"Image":i.model="background-image: url("+i.bg.image+");  background-repeat: no-repeat; background-size:cover";break}},true)}}}]).directive("bsSelectpicker",["$compile","$timeout","$parse",function(b,a,c){return{restrict:"A",link:function(f,e,d){a(function(){$(e).selectpicker()},200)}}}]).directive("dnnsfFieldSelect",["$compile","$timeout","$parse","dnnsf",function($compile,$timeout,$parse,dnnsf){return{restrict:"A",scope:{model:"=ngModel",fields:"=",filterType:"=",currentItem:"="},templateUrl:"static/dnnsf/tpl/field-select.html?v="+dnnsf.env.version,link:function(scope,element,attrs){scope.byType=function(type){var types=dnnsf.eval(type);types=dnnsf.toArray(types);return function(item){return types.length==0||$.inArray(item.InputTypeStr,types)!=-1}};scope.exceptItem=function(item){return function(input){return item!=input.BoundName}}}}}]).directive("uiShow",function(){return{restrict:"A",link:function(d,b,a){var f=a.uiShow;var e=(a.uiDuration||"fast");var c=(a.uiEffect||"slide");if(!d.$eval(f)){b.hide()}d.$watch(f,function(h,g){if(h===g){return}if(h){if(c=="fade"){b.stop(true,true).fadeIn(e)}else{b.stop(true,true).slideDown(e)}}else{if(c=="fade"){b.stop(true,true).fadeOut(e)}else{b.stop(true,true).slideUp(e)}}})}}}).directive("uiFocus",["$timeout",function(a){return{restrict:"A",link:function(d,c,b){d.$watch(b.uiFocus,function(e){if(b.uiFocus){a(function(){$(c[0]).focus().select()})}},true)}}}]).directive("dynamic",["$compile",function(a){return{restrict:"A",replace:true,link:function(c,d,b){c.$watch(b.dynamic,function(e){d.html(g_localize(e));a(d.contents())(c)})}}}]);