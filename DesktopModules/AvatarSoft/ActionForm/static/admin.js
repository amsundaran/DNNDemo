function g_localize(a){return a?a["default"]:""}function g_localizeMaybeJson(b){var a=g_localize(b);if(a&&(a[0]=="["&&a[a.length-1]=="]")||(a[0]=="{"&&a[a.length-1]=="}")){a=$.parseJSON(a)}return a}var app=angular.module("ActionForm",["ngAnimate","ui.sortable","ui.spanresize","ui.tinymce","ngDragDrop","dnnsf","dnnsf.components"]);function StringToBool(a){if(typeof(a)!=="string"){return a}if(a.toLowerCase()=="true"){return true}else{if(a.toLowerCase()=="false"){return false}else{return a}}}app.factory("sharedData",["$http","dnnsf",function($http,dnnsf){return{serverValidators:[],resourceVersion:g_resourceVersion,eventActions:{},byType:function(type){var types=dnnsf.eval(type);types=dnnsf.toArray(types);return function(item){return types.length==0||$.inArray(item.InputTypeStr,types)!=-1}},notParentButton:function(action){return function(item){return item!=action.$_field}},notInArray:function(arr,currentItem){return function(input){var i=$.inArray(input.BoundName,arr);if(i!=currentItem&&i!=-1){return false}return true}},exceptItem:function(item){return function(input){return item!=input.BoundName}},labelSpacing:{0:"Loose",1:"Normal",2:"Compact"},loadCount:false,loadAddons:function(){if(this.addonsLoading){return}this.addonsLoading=true;var _this=this;$http({method:"GET",url:"//www.dnnsharp.com/DesktopModules/DnnSharp/DnnApiEndpoint/Api.ashx?method=ActionFormExtensions"}).success(function(data,status){_this.addons=data})}}}]);function FormCtrl(i,f,h,b,g,a){i.$sce=g;i.localize=function(j){return g_localize(j)};i.sharedData=h;i.sharedData.form={fields:[]};i.dnnsf=a;i.mode="edit";i.onSave=[];f({method:"GET",url:a.adminApi("GetLicenseStatus")}).success(function(k,j){i.licenseStatus=k});i.templates=g_templates;i.jQueryThemes=g_jQueryThemes;i.fieldDefs=g_fieldDefs;i.predefFields=g_predefFields;i.validatorDefs=g_validatorDefs;i.groupValidatorDefs=g_groupValidatorDefs;console.log(i.fieldDefs);i.fieldDefGroups={};i.commonFields=[];$.each(i.fieldDefs,function(j,m){if(m.Settings.IsCommon){i.commonFields.push(m)}for(var l=0;l<m.Categories.length;l++){i.fieldDefGroups[m.Categories[l]]=i.fieldDefGroups[m.Categories[l]]||[];i.fieldDefGroups[m.Categories[l]].push(m)}});i.sharedData.loadAddons();i.actionDefs=g_actionDefs;i.actionDefGroups={};$.each(g_actionDefs,function(j,k){if(!i.actionDefGroups[k.Settings.Group]){i.actionDefGroups[k.Settings.Group]=[]}i.actionDefGroups[k.Settings.Group].push(k)});i.modified=false;var e=function(){return"Your changes are not saved."};i.notifyModified=function(j){a.log("Modified change, load count "+i.sharedData.loadCount,a.stackTrace());if(i.sharedData.loadCount!=0){i.modified=false;return}a.log("modified: "+i.modified+" => "+j);i.modified=j;if(j){if(window.addEventListener){window.addEventListener("beforeunload",e)}else{window.attachEvent("onbeforeunload",e)}}else{if(window.removeEventListener){window.removeEventListener("beforeunload",e)}else{window.detachEvent("onbeforeunload",e)}}};function c(){i.watchAll&&i.watchAll();a.log("preparing data");i.prepareFields(i.sharedData.form.Fields);i.watchAll=i.$watch("sharedData.form",function(k,j){a.log("watchAllFields triggers...");if(angular.equals(k,j)){a.log("form not modified.");return}a.log("form modified.");i.notifyModified(true)},true)}i.prepareFields=function(j){i.sharedData.serverValidators=[];$.each(j,function(k,l){l.$_uid=a.uniqueId("field",l.FormFieldId);l.AutoName=!l.Name;l.BoundName=l.BoundName||l.Name;i.computeName(l);if(l.CustomValidator1&&i.validatorDefs[l.CustomValidator1]&&i.validatorDefs[l.CustomValidator1].IsServerSideValidation){i.sharedData.serverValidators.push({title:l.Title+" Field: "+i.validatorDefs[l.CustomValidator1].Title+" Failed",value:l.FormFieldId+"-"+i.validatorDefs[l.CustomValidator1].Title})}if(l.CustomValidator2&&i.validatorDefs[l.CustomValidator2]&&i.validatorDefs[l.CustomValidator2].IsServerSideValidation){i.sharedData.serverValidators.push({title:l.Title+" Field: "+i.validatorDefs[l.CustomValidator2].Title+" Failed",value:l.FormFieldId+"-"+i.validatorDefs[l.CustomValidator2].Title})}if(l.ValidationGroup&&i.groupValidatorDefs[l.GroupValidator]&&i.groupValidatorDefs[l.GroupValidator].IsServerSideValidation){i.sharedData.serverValidators.push({title:l.ValidationGroup+": "+i.groupValidatorDefs[l.GroupValidator].Title+" Failed",value:l.ValidationGroup+"-"+i.groupValidatorDefs[l.GroupValidator].Title})}a.initParameters(i.fieldDefs[l.InputTypeStr],l,true)});i.sharedData.serverValidators=$.unique(i.sharedData.serverValidators)};i.appendData=function(k,j){var l="";$.each(i.sharedData.form.Fields,function(m,n){if(n.Def&&n.Def.Settings.HasValue=="false"){return}l+=n.Title+": ["+n.BoundName+"]<br />"});k.Parameters[j]=(k.Parameters[j]||"")+l};i.isDuplicate=function(k){for(var j=0;j<i.sharedData.form.Fields.length;j++){if(k!=i.sharedData.form.Fields[j]&&i.sharedData.form.Fields[j].BoundName==k.BoundName){return true}}};i.save=function(){b(function(){i.notifyModified(false);i.saving=true;i.mode="edit"});f({method:"POST",url:a.adminApi("Save"),data:angular.toJson(i.sharedData.form)}).success(function(l,j){i.sharedData.form=l;c();i.onSave=$.unique(i.onSave);for(var k=0;k<i.onSave.length;k++){i.onSave[k]()}i.onSave=[];b(function(){i.saving=false;i.notifyModified(false)});i.scrollToTop();i.checkAWeberAction()});i.sharedData.form.Fields=$.grep(i.sharedData.form.Fields,function(j){return !j.IsDeleted})};i.checkAWeberAction=function(){var n=i.sharedData.form.Fields;for(var l=0;l<n.length;l++){if(n[l].InputTypeStr=="button"&&n[l].Actions.length>0){var m=n[l].Actions;for(var k=0;k<m.length;k++){if((m[k].ActionType==="SubscribeToAWeber"||m[k].ActionType==="UnsubscribeFromAWeber")&&!m[k].IsDeleted&&(m[k].Parameters.AccessKey===""||m[k].Parameters.AccessKey===undefined)){console.log(i.dnnsf);window.location.href=i.dnnsf.appUrl+"/AWeberAuthorize.aspx?AWeberConsumerKey="+m[k].Definition.Settings.ConsumerKey+"&AWeberConsumerSecret="+m[k].Definition.Settings.ConsumerSecret+"&action="+m[k].Id+"&mid="+i.sharedData.form.ModuleId+"&tabid="+i.sharedData.form.TabId}}}}};i.scrollToTop=function(){$("html, body").animate({scrollTop:0},500);window.top.postMessage(JSON.stringify({type:a.urlParam("comm-prefix")+"-scroll",offset:0}),"*")};function d(){i.sharedData.loadCount++;a.log("fetching data...");f({method:"GET",url:a.adminApi("Get")}).success(function(k,j){if(k.error){alert(k.error)}console.log("data retrieved",k);i.sharedData.form=k;a.log("preparing settings");c();i.sharedData.loadCount--;i.formLoaded=true})}d();i.computeName=function(j){if(!j.AutoName){j.Name=j.BoundName;return}j.Name=null;j.BoundName=j.Title.replace(/[^A-Za-z0-9]/g,"")};i.addField=function(j){b(function(){var m=0;var l=j.Title;if(j.Name=="button"){l="Submit";if(i.sharedData.form.LabelAlign.Value!="top"&&i.sharedData.form.LabelAlign.Value!="inside"){m=i.sharedData.form.LabelWidth.Value}}var k={$_uid:a.uniqueId("newField"),$_isOpen:true,$_isLoaded:true,_hasFocus:true,AutoName:true,Title:l,Name:"",InputTypeStr:j.Name,InputData:"",IsEnabled:true,RowIndex:i.highestRow()+1,ColSpan:12-m,ColOffset:m,Parameters:{},Actions:[]};a.initParameters(j,k);i.sharedData.form.Fields.push(k);i.computeName(k)},50)};i.cloneField=function(j){var k=$.extend({},angular.copy(j),{$_uid:a.uniqueId("newField"),$_isOpen:true,$_isLoaded:true,_hasFocus:true,FormFieldId:-1,RowIndex:i.highestRow()+1,ColSpan:12,ColOffset:0});k.Title+=" Copy";a.initParameters(k.Def,k);console.log(k);i.computeName(k);i.sharedData.form.Fields.push(k)};i.hasButtons=function(){if(!i.sharedData.form||!i.sharedData.form.Fields){return false}return $.grep(i.sharedData.form.Fields,function(k,j){if(k.InputTypeStr=="button"||k.InputTypeStr=="image-button"){return true}}).length>0};i.grid=[];i.highestRow=function(){var j=0;$.each(i.sharedData.form.Fields,function(k,l){if(l.RowIndex>j){j=l.RowIndex}});return j};i.getFixedButtons=function(){var k=[];$.each(i.sharedData.form.Fields,function(m,l){if(l.InputTypeStr=="button"){$.each(l.Actions,function(n,o){if(o.ActionType=="ShowMessage"&&o.Parameters.ButtonsList){$.merge(k,o.Parameters.ButtonsList)}})}else{if(l.InputTypeStr=="button-group"&&l.Parameters.ButtonsList){$.merge(k,l.Parameters.ButtonsList)}}});for(var j in i.sharedData.eventActions){$.each($.grep(i.sharedData.eventActions[j],function(l){return l.ActionType=="ShowMessage"}),function(l,m){if(m.Parameters.ButtonsList){$.merge(k,m.Parameters.ButtonsList)}})}return k};i.buildGrid=function(){var j=[];var k=i.getFixedButtons();a.log("Exclude action buttons from layout ...");a.log(k);$.each(i.sharedData.form.Fields,function(n,p){if(p.InputTypeStr=="button"&&$.inArray(p.BoundName,k)!=-1){return}var m=p.RowIndex-j.length;for(var l=0;l<=m;l++){j.push([])}j[p.RowIndex].push({span:p.ColSpan,row:p.RowIndex,field:p})});i.grid=i.fixGrid(j)};i.fixGrid=function(k){for(var j=0;j<k.length;j++){i.fixGridRow(j,undefined,k)}return i.updateRowIndexes(k)};i.siblingFields=function(j){return $.grep(i.grid[j.row],function(k){return k!=j&&k.field.InputTypeStr})};i.makeFullWidth=function(j){j.field.ColOffset=0;j.field.ColSpan=12;i.fixGridRow(j.row,undefined,i.grid)};i.nextNonEmptyCell=function(k,l){var j=$.inArray(l,k);if(j==-1){return null}while(++j<k.length){if(k[j].field.InputTypeStr){return k[j]}}return null};i.fieldDroped=function(n,o,l,k){var m=i.nextNonEmptyCell(i.grid[l.$modelValue.field.RowIndex],l.$modelValue);if(m){m.field.ColOffset+=l.$modelValue.span}k.$modelValue.field=l.$modelValue.field;k.$modelValue.field.RowIndex=k.$modelValue.row;k.$modelValue.field.ColSpan=k.$modelValue.span;k.$modelValue.field.ColOffset=0;l.$modelValue.field={};var p=i.grid[k.$modelValue.field.RowIndex];var j=$.inArray(k.$modelValue,p);var q=j;while(q>0&&!p[q-1].field.InputTypeStr){k.$modelValue.field.ColOffset+=p[q-1].span;q--}if(j!=p.length-1&&p[j+1].field.InputTypeStr){p[j+1].field.ColOffset=0}i.fixGridRow(k.$modelValue.field.RowIndex,undefined,i.grid);if(k.$modelValue.field.RowIndex!=l.$modelValue.row){i.fixGridRow(l.$modelValue.row,undefined,i.grid)}i.grid=i.updateRowIndexes(i.grid);i.notifyModified(true)};i.moveOnNewRow=function(k){var l=i.nextNonEmptyCell(i.grid[k.field.RowIndex],k);if(l){l.field.ColOffset+=k.span}var j=$.inArray(k,i.grid[k.field.RowIndex]);i.grid[k.field.RowIndex].splice(j,1);i.fixGridRow(k.field.RowIndex);k.field.ColOffset=0;k.field.ColSpan=12;k.field.RowIndex++;i.grid.splice(k.field.RowIndex,0,[k]);i.fixGridRow(k.field.RowIndex,undefined,i.grid);i.grid=i.updateRowIndexes(i.grid);i.notifyModified(true)};i.fieldResized=function(k,q,o){var s=i.grid[k.field.RowIndex];var j=$.inArray(k,s);if(o=="left"){if(q>0){var p=q;k.field.ColOffset+=p;k.field.ColSpan-=p}else{var p=q;if(k.field.ColOffset+p<0){p=-k.field.ColOffset}k.field.ColOffset+=p;k.field.ColSpan-=p}}else{var l=j+1;var r=s[l++];while(!r.field.InputTypeStr&&l<s.length){r=s[l++]}if(!r.field.InputTypeStr){var n=0;for(var m=0;m<j;m++){if(s[m].field.InputTypeStr){n+=s[m].field.ColOffset+s[m].field.ColSpan}}n+=s[j].field.ColOffset;k.field.ColSpan=Math.max(1,Math.min(k.field.ColSpan+q,12-n))}else{var p=Math.min(q,r.field.ColOffset);if(k.field.ColSpan+p<=0){p=-k.field.ColSpan-1}k.field.ColSpan+=p;r.field.ColOffset-=p}}i.fixGridRow(k.field.RowIndex,undefined,i.grid);i.notifyModified(true)};i.rowOrderChanged=function(j,k){i.grid=i.updateRowIndexes(i.grid);i.notifyModified(true)};i.editOrderChanged=function(j,k){};i.updateRowIndexes=function(j){j=$.grep(j,function(k){return k.length!=1||k[0].field.InputTypeStr});$.each(j,function(k,l){$.each(l,function(n,m){m.row=k;m.field.RowIndex=k;m.field.ViewOrder=k*12+i.colNumber(j,m)})});i.sharedData.form.Fields.sort(function(l,k){return l.ViewOrder>k.ViewOrder?1:(l.ViewOrder<k.ViewOrder?-1:0)});return j};i.colNumber=function(l,n){var j=0;var o=l[n.row];for(var m=0;m<o.length;m++){var k=o[m];if(k==n){return j+k.field.ColOffset}if(k.field.InputTypeStr){j+=k.field.ColOffset}j+=k.span}return -1};i.fixGridRow=function(o,m,j){j=j||i.grid;var r=o-j.length;for(var l=0;l<=r;l++){j.push([])}j[o]=$.grep(j[o],function(s){return s.field.InputTypeStr});var n=0;$.each(j[o],function(s,t){n+=t.field.ColOffset+t.field.ColSpan});a.log("A total of "+n+" found on row "+o);if(n>12){n=0;$.each(j[o],function(s,t){t.field.ColOffset=0;n+=t.field.ColSpan});if(n>12){var p=Math.ceil((n-12)/j[o].length);$.each(j[o],function(s,t){t.field.ColSpan-=p})}}var k=0;var q=0;$.each($.extend([],j[o]),function(s,t){t.span=t.field.ColSpan;t.row=t.field.RowIndex;t.field.ViewOrder=t.field.RowIndex*12+i.colNumber(j,t);if(t.field.ColOffset){j[o].splice(s+q,0,{row:o,span:t.field.ColOffset,field:{}});q++}k+=t.field.ColOffset+t.field.ColSpan});j[o].push({row:o,span:k>12?0:12-k,field:{}})}}FormCtrl.$inject=["$scope","$http","sharedData","$timeout","$sce","dnnsf"];function EventCtrl(d,f,a,e,c){d.actions=[];d.actionDefs=g_actionDefs;d.actionDefGroups={};d.dnnsf=c;$.each(d.actionDefs,function(g,h){h.Groups&&$.each(h.Groups,function(i,j){if(!d.actionDefGroups[j]){d.actionDefGroups[j]=[]}d.actionDefGroups[j].push(h)});if(!d.actionDefGroups[h.Settings.Group]){d.actionDefGroups[h.Settings.Group]=[]}d.actionDefGroups[h.Settings.Group].push(h)});d.init=function(g,j,i,h){d.actions.watchAllActions&&d.actions.watchAllActions();d.eventName=g;d.field=i;d.eventFriendlyTitle=j;if(i&&!i.Actions){c.log("Loading "+g+" actions from action list ",h);d.actions=h;d.prepareActions()}else{if(i){c.log("Loading "+g+" actions for field ",i);d.actions=i.Actions||[];d.prepareActions()}else{c.log("Loading actions for event "+g);b(g)}}};d.addAction=function(g){e(function(){var h={Id:-1,FieldId:d.field?d.field.FormFieldId:null,$_uid:c.uniqueId("newAction"),$_field:d.field,EventName:d.eventName,Parameters:{},ActionType:g.Id,$_isOpen:true,$_isLoaded:true,$_isFocus:true};c.initParameters(g,h);d.actions.push(h)},50)};d.deleteAction=function(g){g.IsDeleted=true};d.prepareActions=function(){c.log("preparing actions",d.actions);d.actions.watchAllActions&&d.actions.watchAllActions();$.each(d.actions,function(h,i){i.$_uid=c.uniqueId("action",i.Id);i.$_field=d.field;var g=d.actionDefs[i.ActionType];if(typeof g=="undefined"){return}c.initParameters(g,i,true)});e(function(){});d.actions.watchAllActions=d.$watch("actions",function(h,g){c.log("check actions changed for "+d.eventName);if(angular.equals(h,g)){return}if(!d.field&&$.inArray(d.save,d.onSave)==-1){c.log("onSave handler registered for saving actions of "+d.eventName);d.onSave.push(d.save)}c.log("actions changed for "+d.eventName)},true)};function b(g){d.sharedData.loadCount++;f({method:"GET",url:c.adminApi("GetEventActions",{eventName:g})}).success(function(i,h){c.log("got "+i.length+" actions for event "+g);d.actions=i;d.prepareActions();d.sharedData.loadCount--;d.sharedData.eventActions[g]=d.actions})}d.checkFinal=function(g){if(!d.actionDefs[g.ActionType]){return false}return d.actionDefs[g.ActionType].Final&&!g.Condition&&$.inArray(g,d.actions)!=d.actions.length-1};d.save=function(){if(d.field){return}f({method:"POST",url:c.adminApi("SaveEventActions",{eventName:d.eventName}),data:angular.toJson(d.actions)}).success(function(h,g){d.actions=h;$.each(d.actions,function(j,i){i.$_uid=c.uniqueId("action",i.Id)});d.prepareActions()});d.actions=$.grep(d.actions,function(g){return !g.IsDeleted})}}EventCtrl.$inject=["$scope","$http","sharedData","$timeout","dnnsf"];$(function(){$(document).on("mouseover",".help",function(){if($(this).attr("data-original-title")){return}$(this).popover({html:true,placement:"top"})});$(window).hashchange(function(){var c=location.hash;$("#navbar").find("li").removeClass("active");$("#navbar").find("[href="+c+"]").parent().addClass("active")});$(document).on("mouseenter",".btn-link-animate-trigger",function(){$(this).find(".btn-link-animate").each(function(){$(this).removeClass("btn-link").addClass("btn-"+$(this).attr("data-link-animate")).stop(true,false).animate({opacity:1}).find("i").addClass("glyphicon-white")})}).on("mouseleave",".btn-link-animate-trigger",function(){$(this).find(".btn-link-animate").each(function(){$(this).addClass("btn-link").removeClass("btn-"+$(this).attr("data-link-animate")).stop(true,false).animate({opacity:0.7}).find("i").removeClass("glyphicon-white")})}).on("click",".dropdown-submenu>a",function(){return false});$('a[href*="#"]').click(function(){var c=$(this).attr("href");if(c=="#"){return}var e=c.substr(c.indexOf("#"));var d=c.substr(0,c.indexOf("#"));if(d.toLowerCase()&&d.toLowerCase()!=window.location.pathname.toLowerCase()){return}$("html, body").animate({scrollTop:$(e).offset().top-20},500);window.top.postMessage(JSON.stringify({type:dnnsf.urlParam("comm-prefix")+"-scroll",offset:$(e).offset().top}),"*");return false});try{$.ajax({dataType:"json",url:"http://support.dnnsharp.com/api/action-form?hasStatus=Working&hasStatus=Delivered&pageSize=5"}).done(function(c){c.length&&$("#pnlLiveStatusActive").show();$.each(c,function(d,e){$("#pnlLiveStatusActive .list").append('<li><a href="http://www.dnnsharp.com/Support#opturl='+encodeURIComponent(e.url)+'" target="_top">'+e.name+"</a> ("+e.status+")</li>")})});$.ajax({dataType:"json",url:"http://support.dnnsharp.com/api/action-form?hasStatus=Feature%20Request&pageSize=10&sortby=score"}).done(function(c){c.length&&$("#pnlLiveStatus").show();$.each(c,function(d,e){$("#pnlLiveStatus .list").append('<li><a href="http://www.dnnsharp.com/Support#opturl='+encodeURIComponent(e.url)+'" target="_top">'+e.name+" (<u>vote</u> or <u>fund</u>)</a></li>")})})}catch(b){}if(window.postMessage&&window.top){var a=0;setInterval(function(){var c=$("body").height()+50;if(c!=a){a=c;window.top.postMessage(JSON.stringify({type:dnnsf.urlParam("comm-prefix")+"-height",height:a}),"*")}},200)}if(window.top!=window){$(".visible-in-iframe").show()}else{$(".visible-in-iframe").hide()}});